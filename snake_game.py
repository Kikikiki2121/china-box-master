#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Игра "Змейка" на Python с использованием pygame
Управление: стрелки на клавиатуре
"""

import pygame
import random
import sys

# Инициализация pygame
pygame.init()

# Константы игры
ШИРИНА_ОКНА = 800
ВЫСОТА_ОКНА = 600
РАЗМЕР_КЛЕТКИ = 20
СКОРОСТЬ_ИГРЫ = 10

# Цвета (R, G, B)
ЧЕРНЫЙ = (0, 0, 0)
БЕЛЫЙ = (255, 255, 255)
КРАСНЫЙ = (255, 0, 0)
ЗЕЛЕНЫЙ = (0, 255, 0)
СИНИЙ = (0, 0, 255)
ЖЕЛТЫЙ = (255, 255, 0)

class Змейка:
    """Класс для управления змейкой"""
    
    def __init__(self):
        """Инициализация змейки"""
        self.длина = 1
        # Начальная позиция в центре экрана
        start_x = ШИРИНА_ОКНА // 2
        start_y = ВЫСОТА_ОКНА // 2
        self.позиции = [(start_x, start_y)]
        self.направление = (РАЗМЕР_КЛЕТКИ, 0)  # Движение вправо
        self.цвет = ЗЕЛЕНЫЙ
        self.счет = 0
    
    def получить_голову(self):
        """Возвращает позицию головы змейки"""
        return self.позиции[0]
    
    def двигаться(self):
        """Перемещение змейки"""
        текущая_голова = self.получить_голову()
        x, y = self.направление
        новая_голова = (
            (текущая_голова[0] + x) % ШИРИНА_ОКНА,
            (текущая_голова[1] + y) % ВЫСОТА_ОКНА
        )
        
        # Проверка столкновения с самой собой
        if len(self.позиции) > 2 and новая_голова in self.позиции[2:]:
            return False
        
        # Добавляем новую голову
        self.позиции.insert(0, новая_голова)
        
        # Удаляем хвост, если не съели еду
        if len(self.позиции) > self.длина:
            self.позиции.pop()
        
        return True
    
    def изменить_направление(self, новое_направление):
        """Изменение направления движения"""
        # Нельзя двигаться в противоположную сторону
        if (новое_направление[0] * -1, новое_направление[1] * -1) != self.направление:
            self.направление = новое_направление
    
    def вырасти(self):
        """Увеличение длины змейки"""
        self.длина += 1
        self.счет += 10
    
    def рисовать(self, поверхность):
        """Отрисовка змейки"""
        for i, сегмент in enumerate(self.позиции):
            # Голова ярче
            if i == 0:
                цвет = ЖЕЛТЫЙ
            else:
                цвет = self.цвет
            
            прямоугольник = pygame.Rect(
                сегмент[0], сегмент[1],
                РАЗМЕР_КЛЕТКИ, РАЗМЕР_КЛЕТКИ
            )
            pygame.draw.rect(поверхность, цвет, прямоугольник)
            pygame.draw.rect(поверхность, БЕЛЫЙ, прямоугольник, 1)


class Еда:
    """Класс для управления едой"""
    
    def __init__(self):
        """Инициализация еды"""
        self.позиция = (0, 0)
        self.цвет = КРАСНЫЙ
        self.создать_новую()
    
    def создать_новую(self):
        """Создание еды в случайной позиции"""
        x = random.randint(0, (ШИРИНА_ОКНА // РАЗМЕР_КЛЕТКИ) - 1) * РАЗМЕР_КЛЕТКИ
        y = random.randint(0, (ВЫСОТА_ОКНА // РАЗМЕР_КЛЕТКИ) - 1) * РАЗМЕР_КЛЕТКИ
        self.позиция = (x, y)
    
    def рисовать(self, поверхность):
        """Отрисовка еды"""
        прямоугольник = pygame.Rect(
            self.позиция[0], self.позиция[1],
            РАЗМЕР_КЛЕТКИ, РАЗМЕР_КЛЕТКИ
        )
        pygame.draw.rect(поверхность, self.цвет, прямоугольник)
        pygame.draw.rect(поверхность, БЕЛЫЙ, прямоугольник, 1)


class Игра:
    """Основной класс игры"""
    
    def __init__(self):
        """Инициализация игры"""
        self.окно = pygame.display.set_mode((ШИРИНА_ОКНА, ВЫСОТА_ОКНА))
        pygame.display.set_caption('Змейка')
        self.часы = pygame.time.Clock()
        self.змейка = Змейка()
        self.еда = Еда()
        self.шрифт = pygame.font.Font(None, 36)
        self.игра_закончена = False
    
    def обработать_события(self):
        """Обработка событий"""
        for событие in pygame.event.get():
            if событие.type == pygame.QUIT:
                return False
            
            elif событие.type == pygame.KEYDOWN:
                if self.игра_закончена:
                    # Перезапуск игры при нажатии пробела
                    if событие.key == pygame.K_SPACE:
                        self.__init__()
                    # Выход при нажатии ESC
                    elif событие.key == pygame.K_ESCAPE:
                        return False
                else:
                    # Управление змейкой
                    if событие.key == pygame.K_UP:
                        self.змейка.изменить_направление((0, -РАЗМЕР_КЛЕТКИ))
                    elif событие.key == pygame.K_DOWN:
                        self.змейка.изменить_направление((0, РАЗМЕР_КЛЕТКИ))
                    elif событие.key == pygame.K_LEFT:
                        self.змейка.изменить_направление((-РАЗМЕР_КЛЕТКИ, 0))
                    elif событие.key == pygame.K_RIGHT:
                        self.змейка.изменить_направление((РАЗМЕР_КЛЕТКИ, 0))
        
        return True
    
    def обновить(self):
        """Обновление состояния игры"""
        if not self.игра_закончена:
            # Движение змейки
            if not self.змейка.двигаться():
                self.игра_закончена = True
                return
            
            # Проверка съедания еды
            if self.змейка.получить_голову() == self.еда.позиция:
                self.змейка.вырасти()
                self.еда.создать_новую()
                
                # Проверка, что еда не появилась на змейке
                while self.еда.позиция in self.змейка.позиции:
                    self.еда.создать_новую()
    
    def рисовать(self):
        """Отрисовка игры"""
        # Очистка экрана
        self.окно.fill(ЧЕРНЫЙ)
        
        # Рисуем змейку и еду
        self.змейка.рисовать(self.окно)
        self.еда.рисовать(self.окно)
        
        # Отображение счета
        текст_счета = self.шрифт.render(
            f'Счет: {self.змейка.счет}',
            True,
            БЕЛЫЙ
        )
        self.окно.blit(текст_счета, (10, 10))
        
        # Если игра закончена
        if self.игра_закончена:
            текст_конец = self.шрифт.render(
                'Игра окончена!',
                True,
                КРАСНЫЙ
            )
            текст_рестарт = self.шрифт.render(
                'Пробел - новая игра, ESC - выход',
                True,
                БЕЛЫЙ
            )
            
            # Центрируем текст
            self.окно.blit(
                текст_конец,
                (ШИРИНА_ОКНА // 2 - текст_конец.get_width() // 2,
                 ВЫСОТА_ОКНА // 2 - 50)
            )
            self.окно.blit(
                текст_рестарт,
                (ШИРИНА_ОКНА // 2 - текст_рестарт.get_width() // 2,
                 ВЫСОТА_ОКНА // 2 + 10)
            )
        
        # Обновление экрана
        pygame.display.flip()
    
    def запустить(self):
        """Главный игровой цикл"""
        работает = True
        
        while работает:
            работает = self.обработать_события()
            self.обновить()
            self.рисовать()
            self.часы.tick(СКОРОСТЬ_ИГРЫ)
        
        pygame.quit()
        sys.exit()


if __name__ == '__main__':
    игра = Игра()
    игра.запустить()
